<!DOCTYPE html>
<html>
  <head>
    <title>WebRTC + WebSocket</title>
    <style>
      video { width: 45%; margin: 10px; border: 2px solid #ccc; border-radius: 8px; }
      #results { margin-top: 20px; font-size: 18px; font-family: monospace; background: #eee; padding: 10px; }
    </style>
  </head>
  <body>
    <h2>üìπ Video g·ªëc | Video x·ª≠ l√Ω (Testing ZONE)</h2>
    <video id="local" autoplay muted playsinline></video>
    <video id="remote" autoplay playsinline></video>

    <div id="results">‚è≥ ƒêang ch·ªù nh·∫≠n di·ªán...</div>

    <script>
      const pc = new RTCPeerConnection();
      const localVideo = document.getElementById('local');
      const remoteVideo = document.getElementById('remote');
      const resultDiv = document.getElementById('results');
    
      // 1. T·∫°o session_id duy nh·∫•t cho m·ªói phi√™n
      const sessionId = crypto.randomUUID(); // ‚úÖ c·∫ßn h·ªó tr·ª£ tr√¨nh duy·ªát >= Chrome 92
    
      // G·ª≠i webcam qua WebRTC
      (async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        localVideo.srcObject = stream;
        stream.getTracks().forEach(track => pc.addTrack(track, stream));
    
        pc.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };
    
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    
        const res = await fetch("/api/stream_offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type,
            session_id: sessionId // ‚úÖ g·ª≠i session_id
          })
        });
    
        const answer = await res.json();
        await pc.setRemoteDescription(answer);
      })();
    
      // K·∫øt n·ªëi WebSocket v·ªõi session_id
      const socket = new WebSocket("ws://" + location.host + "/api/stream_ws?session_id=" + sessionId);
      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        resultDiv.textContent = "üì∏ Bi·ªÉn s·ªë: " +
          (data.plates && data.plates.length > 0 ? data.plates.map(p => p.text).join(", ") : "Kh√¥ng ph√°t hi·ªán") +
          " | Th·ªùi gian: " + new Date(data.timestamp * 1000).toLocaleTimeString();
      };
    </script>
    
  </body>
</html>
